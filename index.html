<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶™‡ßç‡¶∞‡ßã ‚Äî Final</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg1:#0b1220; --bg2:#071828;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.06);
    --accentA:#00d4ff; --accentB:#7b61ff;
    --success:#00e676; --danger:#ff6b6b;
    --muted: rgba(255,255,255,0.75);
    --radius:16px;
    --safe-pad:14px;
  }
  *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,'Noto Sans Bengali',sans-serif}
  html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#eaf6ff;-webkit-font-smoothing:antialiased}
  .app{max-width:980px;margin:18px auto;padding:12px}
  .layout{display:grid;grid-template-columns:1fr 380px;gap:16px}
  @media (max-width:900px){.layout{grid-template-columns:1fr;padding-bottom:64px}}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021018}
  h1{font-size:18px;margin:0}
  .muted{color:var(--muted);font-size:13px}
  .big-balance{font-size:34px;font-weight:800;color:linear-gradient(90deg,var(--accentA),var(--accentB));background:linear-gradient(90deg,var(--accentA),var(--accentB));-webkit-background-clip:text;background-clip:text}
  .small-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .stat{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;text-align:center}
  button{border:0;padding:12px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#021018}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
  .btn-success{background:var(--success);color:#022}
  .btn-danger{background:var(--danger);color:#210}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .ref-row{display:flex;gap:8px;align-items:center;margin-top:12px}
  .ref-row input{flex:1}
  .ad-slot{margin-top:12px;border-radius:12px;padding:14px;background:linear-gradient(90deg,rgba(255,255,255,0.01),transparent);text-align:center}
  .tasks-list{display:grid;gap:10px;margin-top:12px}
  .task{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .task .left{max-width:70%}
  .task h4{margin:0;font-size:14px}
  .task p{margin:6px 0 0;font-size:12px;color:var(--muted)}
  .touch{transition:transform .12s ease, box-shadow .12s;user-select:none}
  .touch:active{transform:translateY(3px) scale(.997);box-shadow:0 2px 10px rgba(0,0,0,0.4)}
  .popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);z-index:9999;padding:0;border-radius:14px;overflow:hidden;width:92%;max-width:420px;opacity:0;pointer-events:none}
  .popup.show{opacity:1;pointer-events:auto;animation:pop .36s cubic-bezier(.2,.9,.2,1)}
  @keyframes pop{0%{transform:translate(-50%,-50%) scale(.96);opacity:0}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
  .popup .box{padding:20px;background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02))}
  .popup h3{margin:0 0 8px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);top:18px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#021018;font-weight:700;z-index:99999;opacity:0;pointer-events:none}
  .toast.show{opacity:1;pointer-events:auto;animation:toastIn .36s}
  @keyframes toastIn{0%{transform:translate(-50%,-6px) scale(.98);opacity:0}100%{transform:translateX(-50%) scale(1);opacity:1}}
  .admin-only{display:none}
  .users-table{width:100%;border-collapse:collapse;margin-top:8px}
  .users-table th,.users-table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;text-align:left}
  .history-list{max-height:200px;overflow:auto;margin-top:8px}
  .chip{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
  .footer-note{font-size:12px;color:var(--muted);margin-top:10px;text-align:center}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand">
      <div class="logo">TI</div>
      <div>
        <h1>‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶™‡ßç‡¶∞‡ßã</h1>
        <div class="muted">Adsterra + Monetag ‚Ä¢ Referral ‚Ä¢ Social Tasks ‚Ä¢ Admin</div>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <div class="muted">Admin ID: <strong id="adminId">6728725622</strong></div>
      <div class="muted" id="tgUserInfo">Telegram: ‚Äî</div>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT column: User UI -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
          <div>
            <div class="muted">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
            <div class="big-balance" id="ui_balance">‡ß≥ 0.00</div>
            <div class="muted" style="margin-top:6px">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ: ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡ß≥‡ß®‡ß´‡ß¶ ¬∑ ‡¶®‡¶ó‡¶¶ ‡ß≥‡ß™‡ß¶‡ß¶ ¬∑ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡ß≥‡ßÆ‡ß´‡ß¶ ¬∑ <strong>‡ß´ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®</strong></div>
          </div>

          <div style="width:200px">
            <div class="ref-row">
              <input id="refLink" readonly />
              <button class="btn btn-ghost touch" onclick="copyRef()">‡¶ï‡¶™‡¶ø</button>
            </div>
            <div style="height:8px"></div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-primary touch" onclick="watchAd()">üì∫ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® +‡ß≥2</button>
              <button class="btn btn-success touch" onclick="withdrawUI()">üí∏ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</button>
            </div>
          </div>
        </div>

        <div class="small-grid">
          <div class="stat"><div class="muted">‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßá‡¶õ‡ßá‡¶®</div><div style="font-weight:800;font-size:18px" id="ui_ads">0</div></div>
          <div class="stat"><div class="muted">‡¶∞‡ßá‡¶´‡¶æ‡¶∞</div><div style="font-weight:800;font-size:18px" id="ui_refs">0</div></div>
          <div class="stat"><div class="muted">‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</div><div style="font-weight:800;font-size:18px" id="ui_earned">‡ß≥0.00</div></div>
        </div>
      </div>

      <!-- Ads slot with rotation -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Ad Slot (Adsterra / Monetag rotation)</strong><div class="muted">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ publisher script ‡¶¨‡¶∏‡¶æ‡¶®</div></div>
          <div class="chip" id="adModeChip">Mode: Auto</div>
        </div>
        <div id="adSlot" class="ad-slot">
          <!-- PLACE YOUR ADSTER or MONETAG SCRIPT HERE -->
          <!-- Example placeholders ‚Äî replace with real publisher scripts -->
          <div id="adPlaceholder">
            <div class="muted">[Ad will appear here ‚Äî demo]</div>
            <div style="height:8px"></div>
            <button class="btn btn-ghost touch" onclick="simulateAdClick()">Simulate Ad</button>
          </div>
        </div>
      </div>

      <!-- Social tasks -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Social Tasks</strong>
            <div class="muted">Follow / Subscribe / Comment ‡¶ï‡¶∞‡ßá ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</div>
          </div>
          <div class="chip" id="taskCountChip">0 tasks</div>
        </div>

        <div class="tasks-list" id="tasksList"></div>
        <div class="footer-note">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶π‡¶¨‡ßá ‚Äî ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá (Admin approves)</div>
      </div>

      <!-- User withdraw history -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Your Withdraw Requests</strong><div class="muted">LocalStorage-logged</div></div>
          <div class="chip" id="yourReqCount">0</div>
        </div>
        <div class="history-list" id="userHistory"></div>
      </div>
    </div>

    <!-- RIGHT column: Admin -->
    <div>
      <div id="adminPanel" class="card admin-only">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Admin Panel</strong><div class="muted">Manage users, tasks & withdraws</div></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost touch" onclick="refreshAll()">Refresh</button>
            <button class="btn btn-danger touch" onclick="logoutAdmin()">Logout</button>
          </div>
        </div>

        <!-- Users table -->
        <div style="margin-top:12px">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="adminSearch" placeholder="Search user id" oninput="renderUsers()" />
            <button class="btn btn-primary touch" onclick="openCreateUser()">‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</button>
          </div>
          <table class="users-table" id="usersTable">
            <thead><tr><th>User ID</th><th>Balance</th><th>Refs</th><th>Ads</th><th>Actions</th></tr></thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>

        <!-- Withdraw requests -->
        <div style="margin-top:12px">
          <strong>Withdraw Requests</strong>
          <div class="history-list" id="adminWithdraws"></div>
        </div>

        <!-- Task management -->
        <div style="margin-top:12px">
          <strong>Social Tasks (Admin)</strong>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="taskTitle" placeholder="Title (e.g. Follow on Facebook)" />
            <input id="taskReward" placeholder="Reward ‡ß≥ (e.g. 2)" />
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="taskLink" placeholder="Link (https://...)" />
            <input id="taskTax" placeholder="Tax % (e.g. 10)"/>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="taskType">
              <option value="follow">Follow</option>
              <option value="subscribe">Subscribe</option>
              <option value="comment">Comment</option>
              <option value="visit">Visit</option>
            </select>
            <button class="btn btn-success touch" onclick="addTask()">Add Task</button>
            <button class="btn btn-ghost touch" onclick="loadDefaultTasks()">Load Defaults</button>
          </div>
        </div>

        <!-- System -->
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn btn-ghost touch" onclick="exportData()">Export Data</button>
          <button class="btn btn-danger touch" onclick="clearAllConfirm()">Clear All</button>
        </div>
      </div>

      <!-- If not admin -->
      <div id="notAdminMsg" class="card" style="display:none">
        <div class="muted">Admin panel visible only to admin Telegram ID.</div>
      </div>
    </div>
  </div>
</div>

<!-- Welcome popup -->
<div id="welcomePopup" class="popup">
  <div class="box card">
    <h3>‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! üéâ</h3>
    <div class="muted">‚Äú‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶∏‡¶´‡¶≤‡¶§‡¶æ‡¶∞ ‡¶™‡¶•‡ßá! üåü ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶ì ‚Äî ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶¨‡¶æ‡¶°‡¶º‡¶¨‡ßá‡•§‚Äù</div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary touch" onclick="closeWelcome()">‡¶ö‡¶≤ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶ø</button>
      <button class="btn btn-ghost touch" onclick="closeWelcome()">‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶¨</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
/* -------------------------
   Config & Admin TG ID
   ------------------------- */
const ADMIN_TG_ID = "6728725622";
const CONFIG = {
  adEarning: 2.00,
  refBonus: 5.00,
  minRefsToWithdraw: 5,
  cooldownMs: 30000,
  socialDefaultReward: 2.00,
  withdrawMethods: [
    { key:'bkash', label:'‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂', min:250, charge:15 },
    { key:'nagad', label:'‡¶®‡¶ó‡¶¶', min:400, charge:20 },
    { key:'bank', label:'‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï', min:850, charge:30 }
  ],
  adRotationInterval: 15000 // ms rotate between ad networks
};

/* -------------------------
   LocalStorage Keys
   ------------------------- */
const KEY_USERS_INDEX = 'ti_users_index_v2';
const KEY_WITHDRAWS = 'ti_withdraws_v2';
const KEY_TASKS = 'ti_tasks_v2';
const KEY_GUEST = 'ti_guest_v2';
const KEY_REFFERED_FLAG_PREFIX = 'ti_referred_flag_';

/* -------------------------
   Telegram WebApp init
   ------------------------- */
let tg = null, tgUser = null;
try {
  tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  tg.initDataUnsafe && (tgUser = tg.initDataUnsafe.user);
  if(tgUser){
    document.getElementById('tgUserInfo').innerText = `Telegram: ${tgUser.first_name || ''} ${tgUser.username ? '('+tgUser.username+')' : ''} ‚Äî id: ${tgUser.id}`;
  }
} catch(e){
  console.warn('Telegram not available', e);
}

/* -------------------------
   Helpers
   ------------------------- */
function nowStr(){ return new Date().toLocaleString('bn-BD'); }
function uid(){ return 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2,8); }
function toast(msg, bgGradient=null){
  const t = document.getElementById('toast');
  t.innerText = msg;
  if(bgGradient) t.style.background = bgGradient; else t.style.background = 'linear-gradient(90deg,var(--accentA),var(--accentB))';
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2400);
}
function vibrate(ms=20){ if(navigator.vibrate) navigator.vibrate(ms); }

/* -------------------------
   Storage utilities
   ------------------------- */
function getIndex(){ try{ const r=localStorage.getItem(KEY_USERS_INDEX); return r?JSON.parse(r):[];}catch(e){return[]} }
function saveIndex(idx){ localStorage.setItem(KEY_USERS_INDEX, JSON.stringify(idx)); }
function saveUser(id, data){ localStorage.setItem(id, JSON.stringify(data)); let idx=getIndex(); if(!idx.includes(id)){ idx.push(id); saveIndex(idx);} }
function getUser(id){ const r = localStorage.getItem(id); return r?JSON.parse(r):null; }
function deleteUser(id){ localStorage.removeItem(id); let idx=getIndex().filter(x=>x!==id); saveIndex(idx); }
function getWithdraws(){ const r = localStorage.getItem(KEY_WITHDRAWS); return r?JSON.parse(r):[]; }
function saveWithdraws(arr){ localStorage.setItem(KEY_WITHDRAWS, JSON.stringify(arr)); }
function addWithdraw(entry){ const arr = getWithdraws(); arr.unshift(entry); saveWithdraws(arr); }
function getTasks(){ const r = localStorage.getItem(KEY_TASKS); return r?JSON.parse(r):[]; }
function saveTasks(arr){ localStorage.setItem(KEY_TASKS, JSON.stringify(arr)); }

/* -------------------------
   Current visitor (tg or guest)
   ------------------------- */
let CURRENT_USER_ID = (tgUser && tgUser.id) ? `tg_${tgUser.id}` : null;
function ensureCurrentUser(){
  if(!CURRENT_USER_ID){
    let guest = localStorage.getItem(KEY_GUEST);
    if(!guest){ guest = uid(); localStorage.setItem(KEY_GUEST, guest); }
    CURRENT_USER_ID = guest;
  }
  let u = getUser(CURRENT_USER_ID);
  if(!u){ u = { id: CURRENT_USER_ID, balance:0, adsWatched:0, refs:0, totalEarned:0, createdAt: nowStr(), lastAd:0 }; saveUser(CURRENT_USER_ID, u); }
  // referral check
  try{
    const params = new URLSearchParams(window.location.search);
    const start = params.get('start');
    if(start && start.startsWith('ref_')){
      const refId = start.replace('ref_','');
      if(refId && refId !== CURRENT_USER_ID){
        const flag = KEY_REFFERED_FLAG_PREFIX + refId + '_' + CURRENT_USER_ID;
        if(!localStorage.getItem(flag)){
          let refUser = getUser(refId) || { id:refId, balance:0, refs:0, totalEarned:0 };
          refUser.refs = (refUser.refs||0) + 1;
          refUser.balance = (refUser.balance||0) + CONFIG.refBonus;
          refUser.totalEarned = (refUser.totalEarned||0) + CONFIG.refBonus;
          saveUser(refId, refUser);
          localStorage.setItem(flag, '1');
        }
      }
    }
  }catch(e){}
}

/* -------------------------
   Initial default tasks
   ------------------------- */
function loadDefaultTasks(){
  const defaults = [
    { id:'t_fb', title:'Follow on Facebook', link:'https://facebook.com', type:'follow', reward:CONFIG.socialDefaultReward, taxPct:10 },
    { id:'t_tw', title:'Follow on Twitter', link:'https://twitter.com', type:'follow', reward:CONFIG.socialDefaultReward, taxPct:8 },
    { id:'t_yt', title:'Subscribe on YouTube', link:'https://youtube.com', type:'subscribe', reward:CONFIG.socialDefaultReward, taxPct:12 },
    { id:'t_tele', title:'Join Telegram Channel', link:'https://t.me', type:'join', reward:CONFIG.socialDefaultReward, taxPct:5 },
    { id:'t_ig', title:'Follow on Instagram', link:'https://instagram.com', type:'follow', reward:CONFIG.socialDefaultReward, taxPct:7 }
  ];
  saveTasks(defaults);
  renderTasks();
  toast('Default tasks loaded');
}

/* -------------------------
   UI Renderers
   ------------------------- */
function updateUI(){
  const u = getUser(CURRENT_USER_ID);
  document.getElementById('ui_balance').innerText = `‡ß≥ ${parseFloat((u.balance||0)).toFixed(2)}`;
  document.getElementById('ui_ads').innerText = u.adsWatched||0;
  document.getElementById('ui_refs').innerText = u.refs||0;
  document.getElementById('ui_earned').innerText = `‡ß≥ ${parseFloat((u.totalEarned||0)).toFixed(2)}`;
  document.getElementById('refLink').value = generateRefLink(CURRENT_USER_ID);
  renderTasks();
  renderUserHistory();
  renderUsers();
  renderAdminWithdraws();
  document.getElementById('taskCountChip').innerText = getTasks().length + ' tasks';
}

function generateRefLink(id){
  const base = window.location.origin + window.location.pathname;
  return `${base}?start=ref_${id}`;
}

/* Tasks render & actions */
function renderTasks(){
  const container = document.getElementById('tasksList'); container.innerHTML = '';
  const tasks = getTasks();
  tasks.forEach(t=>{
    const div = document.createElement('div'); div.className='task touch';
    const left = document.createElement('div'); left.className='left';
    left.innerHTML = `<h4>${t.title}</h4><p>${t.type} ‚Ä¢ Reward ‡ß≥${parseFloat(t.reward).toFixed(2)} ‚Ä¢ Tax ${t.taxPct||0}%</p>`;
    const right = document.createElement('div');
    right.innerHTML = `<button class="btn btn-primary touch" onclick="performTask('${t.id}')">Do ‚Ä¢ ‡ß≥${parseFloat(t.reward).toFixed(2)}</button>`;
    div.appendChild(left); div.appendChild(right);
    container.appendChild(div);
  });
}

/* When user performs a task (opens link in new tab) */
function performTask(taskId){
  const t = getTasks().find(x=>x.id===taskId);
  if(!t) return;
  // open link in new tab
  window.open(t.link, '_blank');
  // mark pending verification entry (admin will manually approve)
  const pending = { id:'p_'+Date.now()+'_'+Math.random().toString(36).slice(2,6), userId: CURRENT_USER_ID, taskId: t.id, title: t.title, reward: parseFloat(t.reward), taxPct: parseFloat(t.taxPct||0), status:'pending', createdAt: nowStr() };
  // store pending in withdraws store as 'task' type for admin to approve (we'll use same withdraws store)
  const arr = getWithdraws();
  arr.unshift(pending);
  saveWithdraws(arr);
  toast('Task submitted ‚Äî admin will verify and approve');
  updateUI();
}

/* Simulated ad functions */
function simulateAdClick(){ watchAd(); }

function watchAd(){
  const u = getUser(CURRENT_USER_ID);
  const now = Date.now();
  if(u.lastAd && (now - u.lastAd) < CONFIG.cooldownMs){
    const s = Math.ceil((CONFIG.cooldownMs - (now - u.lastAd))/1000);
    toast(`‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ${s} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®`, 'linear-gradient(90deg,#ffb300,#ff7a00)');
    return;
  }
  // visual play
  toast('Ad playing...');
  setTimeout(()=>{
    u.balance = (u.balance||0) + CONFIG.adEarning;
    u.adsWatched = (u.adsWatched||0) + 1;
    u.totalEarned = (u.totalEarned||0) + CONFIG.adEarning;
    u.lastAd = Date.now();
    saveUser(CURRENT_USER_ID, u);
    vibrate(12);
    toast(`‚úÖ ‡¶Ü‡¶™‡¶®‡¶ø ‡ß≥${CONFIG.adEarning.toFixed(2)} ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®`);
    updateUI();
  }, 3200);
}

/* Withdraw UI */
function withdrawUI(){
  const u = getUser(CURRENT_USER_ID);
  if((u.refs||0) < CONFIG.minRefsToWithdraw){ toast(`‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ${CONFIG.minRefsToWithdraw} ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞`, 'linear-gradient(90deg,#ff6b6b,#ff3d00)'); return; }
  const methods = CONFIG.withdrawMethods.map((m,i)=> `${i+1}. ${m.label} (min ‡ß≥${m.min} ‚Ä¢ charge ‡ß≥${m.charge})`).join('\n');
  const choice = prompt(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥${(u.balance||0).toFixed(2)}\n\n‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:\n${methods}\n\n‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (1-${CONFIG.withdrawMethods.length})`);
  if(!choice) return;
  const idx = parseInt(choice) - 1; if(isNaN(idx) || !CONFIG.withdrawMethods[idx]){ toast('‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®', 'linear-gradient(90deg,#ff6b6b,#ff3d00)'); return; }
  const method = CONFIG.withdrawMethods[idx];
  if((u.balance||0) < method.min){ toast(`${method.label} ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡ß≥${method.min} ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®`, 'linear-gradient(90deg,#ff6b6b,#ff3d00)'); return; }
  const gross = parseFloat(u.balance || 0);
  const net = gross - method.charge;
  const entry = { id:'w_'+Date.now()+'_'+Math.random().toString(36).slice(2,6), userId: CURRENT_USER_ID, type:'withdraw', method:method.key, methodLabel:method.label, gross:gross, charge:method.charge, net:net, status:'requested', createdAt: nowStr() };
  addWithdraw(entry);
  u.balance = 0; saveUser(CURRENT_USER_ID, u);
  toast('‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
  updateUI();
}

/* Render user withdraw history */
function renderUserHistory(){
  const arr = getWithdraws().filter(x=>x.userId===CURRENT_USER_ID);
  const container = document.getElementById('userHistory'); container.innerHTML='';
  if(arr.length===0){ container.innerHTML = '<div class="muted">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>'; return; }
  arr.forEach(a=>{
    const d = document.createElement('div'); d.className='task';
    d.innerHTML = `<div class="left"><strong>${a.type==='withdraw' ? a.methodLabel : 'Task: '+a.title}</strong><p class="muted">${a.createdAt} ‚Ä¢ Status: ${a.status}</p></div><div><div class="chip">‡ß≥ ${ (a.net||a.reward||0).toFixed(2) }</div></div>`;
    container.appendChild(d);
  });
  document.getElementById('yourReqCount').innerText = arr.length;
}

/* -------------------------
   Admin area: visibility & functions
   ------------------------- */
function isAdmin(){
  return tgUser && String(tgUser.id) === ADMIN_TG_ID;
}
function initAdminPanel(){
  if(isAdmin()){
    document.querySelectorAll('.admin-only').forEach(e=>e.style.display='block');
    document.getElementById('notAdminMsg').style.display='none';
  } else {
    document.getElementById('notAdminMsg').style.display='block';
  }
}

/* Render users table */
function renderUsers(){
  const tbody = document.getElementById('usersTbody'); tbody.innerHTML='';
  const q = (document.getElementById('adminSearch')?.value || '').toLowerCase();
  const idx = getIndex();
  const users = idx.map(id=>getUser(id)).filter(Boolean).filter(u=>!q || u.id.toLowerCase().includes(q)).sort((a,b)=> (b.totalEarned||0) - (a.totalEarned||0));
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="font-weight:700">${u.id}</td>
                    <td>‡ß≥ ${(u.balance||0).toFixed(2)}</td>
                    <td>${u.refs||0}</td>
                    <td>${u.adsWatched||0}</td>
                    <td><div style="display:flex;gap:6px"><button class="btn btn-ghost touch" onclick="adminEdit('${u.id}')">Edit</button><button class="btn btn-danger touch" onclick="adminDelete('${u.id}')">Del</button></div></td>`;
    tbody.appendChild(tr);
  });
}

/* Admin edit user */
function adminEdit(id){
  const u = getUser(id);
  if(!u){ toast('User not found','linear-gradient(90deg,#ff6b6b,#ff3d00)'); return; }
  const newBal = prompt('‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ (‡ß≥):', (u.balance||0));
  if(newBal === null) return; const num = parseFloat(newBal);
  if(isNaN(num)){ toast('‡¶Ö‡¶¨‡ßà‡¶ß ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£','linear-gradient(90deg,#ff6b6b,#ff3d00)'); return; }
  u.balance = num; saveUser(id, u); toast('‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá'); renderUsers(); updateUI();
}
function adminDelete(id){
  if(!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?')) return;
  deleteUser(id); toast('User deleted'); renderUsers(); updateUI();
}
function openCreateUser(){
  const newid = prompt('User ID ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: tg_12345) ‡¶¨‡¶æ ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡ßá‡¶ñ‡ßá auto ‡¶¨‡¶æ‡¶®‡¶æ‡¶¨‡ßá:');
  const id = newid && newid.trim() ? newid.trim() : uid();
  if(getUser(id)){ toast('User exists already'); return; }
  const u = { id:id, balance:0, adsWatched:0, refs:0, totalEarned:0, createdAt: nowStr() }; saveUser(id,u); toast('User created'); renderUsers();
}

/* Admin withdraw list render */
function renderAdminWithdraws(){
  const arr = getWithdraws();
  const container = document.getElementById('adminWithdraws'); container.innerHTML='';
  if(arr.length===0){ container.innerHTML = '<div class="muted">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>'; return; }
  arr.forEach(item=>{
    const div = document.createElement('div'); div.className='task';
    const left = document.createElement('div'); left.className='left';
    left.innerHTML = `<strong>${ item.type==='withdraw' ? item.methodLabel + ' ‚Ä¢ ‡ß≥' + (item.net||0).toFixed(2) : 'TASK ‚Ä¢ '+(item.title||'') }</strong><p class="muted">${item.createdAt} ‚Ä¢ ${item.userId} ‚Ä¢ Status: ${item.status}</p>`;
    const right = document.createElement('div');
    if(item.status === 'pending' || item.status==='requested'){
      right.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px"><button class="btn btn-success touch" onclick='adminProcess("${item.id}","approve")'>Approve</button><button class="btn btn-danger touch" onclick='adminProcess("${item.id}","reject")'>Reject</button></div>`;
    } else {
      right.innerHTML = `<div class="muted">${item.status}${item.processedAt? ' ‚Ä¢ '+item.processedAt: ''}</div>`;
    }
    div.appendChild(left); div.appendChild(right); container.appendChild(div);
  });
}

/* Admin process withdraw/task */
function adminProcess(id, action){
  if(!isAdmin()){ toast('Access denied'); return; }
  const arr = getWithdraws();
  const idx = arr.findIndex(x=>x.id===id);
  if(idx===-1){ toast('Not found'); return; }
  const item = arr[idx];
  if(action === 'approve'){
    arr[idx].status = 'completed'; arr[idx].processedAt = nowStr();
    // if task: give reward - tax
    if(item.taskId || item.title){
      // in our model pending entries have reward & taxPct
      const reward = parseFloat(item.reward || item.net || 0);
      const tax = parseFloat(item.taxPct || 0);
      const taxAmount = (tax/100) * reward;
      const netToUser = reward - taxAmount;
      const u = getUser(item.userId) || { id: item.userId, balance:0, totalEarned:0, refs:0 };
      u.balance = (u.balance||0) + netToUser;
      u.totalEarned = (u.totalEarned||0) + netToUser;
      // store admin tax into admin account (we'll save to a dedicated key)
      const adminAcc = getAdminAccount(); adminAcc.taxCollected = (adminAcc.taxCollected||0) + taxAmount; saveAdminAccount(adminAcc);
      saveUser(u.id, u);
    }
    toast('Approved');
  } else if(action === 'reject'){
    arr[idx].status = 'rejected'; arr[idx].processedAt = nowStr();
    // if withdraw request, refund gross
    if(item.type === 'withdraw'){
      const u = getUser(item.userId) || { id: item.userId, balance:0 };
      u.balance = (u.balance||0) + (item.gross||0);
      saveUser(u.id, u);
      toast('Rejected & refunded');
    } else {
      toast('Rejected');
    }
  }
  saveWithdraws(arr); renderAdminWithdraws(); renderUsers(); updateUI();
}

/* admin account (for tax collection) */
const KEY_ADMIN_ACC = 'ti_admin_acc_v2';
function getAdminAccount(){ const r = localStorage.getItem(KEY_ADMIN_ACC); return r?JSON.parse(r):{ taxCollected:0 }; }
function saveAdminAccount(a){ localStorage.setItem(KEY_ADMIN_ACC, JSON.stringify(a)); }

/* Add Task (Admin) */
function addTask(){
  if(!isAdmin()){ toast('Access denied'); return; }
  const title = document.getElementById('taskTitle').value.trim();
  const reward = parseFloat(document.getElementById('taskReward').value) || CONFIG.socialDefaultReward;
  const link = document.getElementById('taskLink').value.trim() || 'https://';
  const tax = parseFloat(document.getElementById('taskTax').value) || 0;
  const type = document.getElementById('taskType').value || 'visit';
  if(!title){ toast('Title missing'); return; }
  const id = 't_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
  const tasks = getTasks(); tasks.unshift({ id:id, title:title, link:link, reward:reward, taxPct:tax, type:type }); saveTasks(tasks);
  document.getElementById('taskTitle').value=''; document.getElementById('taskReward').value=''; document.getElementById('taskLink').value=''; document.getElementById('taskTax').value='';
  renderTasks(); toast('Task added');
}

/* Edit/Remove tasks (Admin) - simplified: double-click list to edit/remove) */
function renderTasksAdmin(){
  // not shown separately; admin uses add/remove from UI
}

/* Export & Clear */
function exportData(){
  if(!isAdmin()){ toast('Access denied'); return; }
  const data = { users:getIndex().map(id=>getUser(id)), withdraws: getWithdraws(), tasks:getTasks(), admin:getAdminAccount() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'ti_export_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
}
function clearAllConfirm(){
  if(!isAdmin()) return;
  if(!confirm('WARNING: Clear all users, withdraws & tasks from LocalStorage?')) return;
  // clear user keys
  getIndex().forEach(id=>localStorage.removeItem(id));
  localStorage.removeItem(KEY_USERS_INDEX);
  localStorage.removeItem(KEY_WITHDRAWS);
  localStorage.removeItem(KEY_TASKS);
  localStorage.removeItem(KEY_ADMIN_ACC);
  localStorage.removeItem(KEY_GUEST);
  toast('All cleared', 'linear-gradient(90deg,#ff6b6b,#ff3d00)');
  updateUI();
}

/* Admin quick helpers */
function adminSetBalanceManual(){
  const id = prompt('User ID:'); if(!id) return;
  const amt = parseFloat(prompt('Amount (‡ß≥):', '0')); if(isNaN(amt)) return;
  let u = getUser(id) || { id:id, balance:0, adsWatched:0, refs:0, totalEarned:0, createdAt: nowStr() };
  u.balance = amt; saveUser(id, u); toast('Balance set'); renderUsers(); updateUI();
}
function adminLogoutLocal(){ localStorage.removeItem('ti_admin_logged'); }

/* Create some defaults if missing */
(function bootstrap(){
  ensureCurrentUser();
  if(!getTasks() || getTasks().length===0) loadDefaultTasks();
  // ensure current user in index
  const idx = getIndex(); if(!idx.includes(CURRENT_USER_ID)){ idx.push(CURRENT_USER_ID); saveIndex(idx); }
  // init admin panel
  initAdminPanel();
  updateUI();
})();

/* Admin visible actions from buttons */
function refreshAll(){ updateUI(); renderAdminWithdraws(); renderUsers(); }
function logoutAdmin(){ toast('Admin logout (Frontend)'); document.querySelectorAll('.admin-only').forEach(e=>e.style.display='none'); }

/* Welcome popup handling */
(function showWelcomeOnce(){
  const key = 'ti_welcome_shown_v2_' + CURRENT_USER_ID;
  if(!localStorage.getItem(key)){
    setTimeout(()=>{ document.getElementById('welcomePopup').classList.add('show'); }, 700);
    localStorage.setItem(key,'1');
  }
})();
function closeWelcome(){ document.getElementById('welcomePopup').classList.remove('show'); }

/* Copy referral */
function copyRef(){ const el = document.getElementById('refLink'); el.select(); el.setSelectionRange(0,99999); document.execCommand('copy'); toast('Referral copied'); }

/* Render admin withdraws initially */
function renderAdminWithdraws(){ renderAdminWithdraws = function(){ /* noop: defined earlier */ }; renderAdminWithdraws(); } // placeholder

/* Touch-friendly: add event listeners for visual press (already using :active and touch class) */

/* Ad rotation (Adsterra / Monetag) simulation */
let adMode = 0; const adModes = ['Adsterra','Monetag'];
function rotateAd(){ adMode = (adMode+1) % adModes.length; document.getElementById('adModeChip').innerText = 'Mode: ' + adModes[adMode]; /* if you have script tags, you can swap them here */ }
setInterval(rotateAd, CONFIG.adRotationInterval);

/* Expose some functions to console for debugging */
window._ti = { getIndex, getUser, getWithdraws, getTasks, addWithdraw, saveUser, loadDefaultTasks };

/* For functions used in attributes but hoisted below */
window.performTask = performTask;
window.simulateAdClick = simulateAdClick;
window.watchAd = watchAd;
window.withdrawUI = withdrawUI;
window.copyRef = copyRef;
window.addTask = addTask;
window.loadDefaultTasks = loadDefaultTasks;
window.refreshAll = refreshAll;
window.openCreateUser = openCreateUser;
window.adminEdit = adminEdit;
window.adminDelete = adminDelete;
window.adminProcess = adminProcess;
window.exportData = exportData;
window.clearAllConfirm = clearAllConfirm;
window.logoutAdmin = logoutAdmin;
</script>
</body>
</html>