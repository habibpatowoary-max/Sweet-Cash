<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶™‡ßç‡¶∞‡ßã ‚Äî Final (Demo Ads)</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg1:#07121a; --bg2:#0a2836;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.06);
    --accent1:#00d4ff; --accent2:#7b61ff;
    --success:#00e676; --danger:#ff6b6b;
    --muted: rgba(255,255,255,0.75);
    --radius:14px;
    --pad:14px;
  }
  *{box-sizing:border-box;font-family:Inter, 'Noto Sans Bengali', system-ui, -apple-system, Roboto, 'Segoe UI', Arial;}
  html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#eaf6ff;-webkit-font-smoothing:antialiased}
  .app{max-width:980px;margin:16px auto;padding:12px}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021018}
  h1{font-size:18px;margin:0}
  .muted{color:var(--muted);font-size:13px}
  .layout{display:grid;grid-template-columns:1fr 380px;gap:16px}
  @media (max-width:920px){.layout{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  .big-balance{font-size:30px;font-weight:800;background:linear-gradient(90deg,var(--accent1),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent}
  .small-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .stat{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;text-align:center}
  button{border:0;padding:12px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021018}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
  .btn-success{background:var(--success);color:#021018}
  .btn-danger{background:var(--danger);color:#210}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .ref-row{display:flex;gap:8px;align-items:center;margin-top:12px}
  .ref-row input{flex:1}
  .ad-slot{margin-top:12px;border-radius:12px;padding:14px;background:linear-gradient(90deg,rgba(255,255,255,0.01),transparent);text-align:center}
  .tasks-list{display:grid;gap:10px;margin-top:12px}
  .task{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .task .left{max-width:70%}
  .task h4{margin:0;font-size:14px}
  .task p{margin:6px 0 0;font-size:12px;color:var(--muted)}
  .touch{transition:transform .12s ease, box-shadow .12s;user-select:none}
  .touch:active{transform:translateY(3px) scale(.997);box-shadow:0 2px 10px rgba(0,0,0,0.4)}
  .popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);z-index:9999;padding:0;border-radius:14px;overflow:hidden;width:92%;max-width:420px;opacity:0;pointer-events:none}
  .popup.show{opacity:1;pointer-events:auto;animation:pop .36s cubic-bezier(.2,.9,.2,1)}
  @keyframes pop{0%{transform:translate(-50%,-50%) scale(.96);opacity:0}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
  .popup .box{padding:20px;background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02))}
  .toast{position:fixed;left:50%;transform:translateX(-50%);top:18px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021018;font-weight:700;z-index:99999;opacity:0;pointer-events:none}
  .toast.show{opacity:1;pointer-events:auto;animation:toastIn .36s}
  @keyframes toastIn{0%{transform:translate(-50%,-6px) scale(.98);opacity:0}100%{transform:translateX(-50%) scale(1);opacity:1}}
  .admin-only{display:none}
  .users-table{width:100%;border-collapse:collapse;margin-top:8px}
  .users-table th,.users-table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px;text-align:left}
  .history-list{max-height:220px;overflow:auto;margin-top:8px}
  .chip{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
  .footer-note{font-size:12px;color:var(--muted);margin-top:10px;text-align:center}
  .mini { font-size:12px;color:var(--muted) }
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand">
      <div class="logo">TI</div>
      <div>
        <h1>‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶™‡ßç‡¶∞‡ßã</h1>
        <div class="muted">Demo Ads ‚Ä¢ Referral ‚Ä¢ Social Tasks ‚Ä¢ Admin</div>
      </div>
    </div>

    <div style="text-align:right">
      <div class="muted">Admin ID: <strong id="adminIdDisplay">6728725622</strong></div>
      <div id="tgUserInfo" class="muted">Telegram: ‚Äî</div>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT - user -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
          <div>
            <div class="muted">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
            <div class="big-balance" id="ui_balance">‡ß≥ 0.00</div>
            <div class="mini">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ: ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡ß≥‡ß®‡ß´‡ß¶ ¬∑ ‡¶®‡¶ó‡¶¶ ‡ß≥‡ß™‡ß¶‡ß¶ ¬∑ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡ß≥‡ßÆ‡ß´‡ß¶ ¬∑ (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß´ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®)</div>
          </div>

          <div style="width:220px">
            <div class="ref-row">
              <input id="refLink" readonly />
              <button class="btn btn-ghost touch" onclick="copyRef()">‡¶ï‡¶™‡¶ø</button>
            </div>
            <div style="height:8px"></div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-primary touch" onclick="playAd()">üì∫ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
              <button class="btn btn-success touch" onclick="withdrawUI()">üí∏ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</button>
            </div>
          </div>
        </div>

        <div class="small-grid">
          <div class="stat"><div class="muted">‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßá‡¶õ‡ßá‡¶®</div><div style="font-weight:800;font-size:18px" id="ui_ads">0</div></div>
          <div class="stat"><div class="muted">‡¶∞‡ßá‡¶´‡¶æ‡¶∞</div><div style="font-weight:800;font-size:18px" id="ui_refs">0</div></div>
          <div class="stat"><div class="muted">‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</div><div style="font-weight:800;font-size:18px" id="ui_earned">‡ß≥0.00</div></div>
        </div>
      </div>

      <!-- Ad slot -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Ad Slot (Demo)</strong><div class="mini">Adsterra + Monetag auto-rotation (demo)</div></div>
          <div class="chip" id="adModeChip">Mode: Demo-Adsterra</div>
        </div>
        <div id="adSlot" class="ad-slot">
          <!-- Demo Adsterra script (placeholder) -->
          <div id="demoAd" style="padding:14px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);">
            <div class="mini">Demo Ad (Adsterra placeholder)</div>
            <div style="height:10px"></div>
            <button class="btn btn-ghost touch" onclick="simulateAdView()">Simulate Ad View</button>
          </div>
        </div>
      </div>

      <!-- Social tasks -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Social Tasks</strong><div class="mini">Follow / Subscribe / Comment ‡¶ï‡¶∞‡ßá ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</div></div>
          <div class="chip" id="taskCountChip">0 tasks</div>
        </div>
        <div class="tasks-list" id="tasksList"></div>
        <div class="footer-note">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ñ‡ßÅ‡¶≤‡¶¨‡ßá‡•§ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡•§</div>
      </div>

      <!-- User withdraw history -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Your Requests</strong><div class="mini">Local withdraw & task submissions</div></div>
          <div class="chip" id="yourReqCount">0</div>
        </div>
        <div class="history-list" id="userHistory"></div>
      </div>
    </div>

    <!-- RIGHT - admin -->
    <div>
      <div id="adminPanel" class="card admin-only">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Admin Panel</strong><div class="mini">Manage users, tasks & withdraws</div></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost touch" onclick="refreshAll()">Refresh</button>
            <button class="btn btn-danger touch" onclick="adminLogout()">Logout</button>
          </div>
        </div>

        <!-- Users table -->
        <div style="margin-top:12px">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input id="adminSearch" placeholder="Search user id" oninput="renderUsers()" />
            <button class="btn btn-primary touch" onclick="openCreateUser()">New User</button>
          </div>
          <table class="users-table" id="usersTable">
            <thead><tr><th>User ID</th><th>Balance</th><th>Refs</th><th>Ads</th><th>Actions</th></tr></thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>

        <!-- Withdraws -->
        <div style="margin-top:12px">
          <strong>Withdraw & Task Requests</strong>
          <div class="history-list" id="adminWithdraws"></div>
        </div>

        <!-- Task management -->
        <div style="margin-top:12px">
          <strong>Social Tasks (Admin)</strong>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="taskTitle" placeholder="Title (e.g. Follow on Facebook)" />
            <input id="taskReward" placeholder="Reward ‡ß≥ (e.g. 5)" />
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="taskLink" placeholder="Link (https://...)" />
            <input id="taskTax" placeholder="Tax % (e.g. 10)"/>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="taskType">
              <option value="follow">Follow</option>
              <option value="subscribe">Subscribe</option>
              <option value="comment">Comment</option>
              <option value="visit">Visit</option>
            </select>
            <button class="btn btn-success touch" onclick="addTask()">Add Task</button>
            <button class="btn btn-ghost touch" onclick="loadDefaultTasks()">Load Defaults</button>
          </div>
        </div>

        <!-- Export / Clear -->
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn btn-ghost touch" onclick="exportData()">Export JSON</button>
          <button class="btn btn-danger touch" onclick="clearAllConfirm()">Clear All</button>
        </div>
      </div>

      <div id="notAdminMsg" class="card" style="display:none">
        <div class="muted">Admin panel visible only to admin Telegram ID.</div>
      </div>
    </div>
  </div>
</div>

<!-- Welcome popup -->
<div id="welcomePopup" class="popup">
  <div class="box card">
    <h3>‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! üéâ</h3>
    <div class="muted">‚Äú‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶∏‡¶´‡¶≤‡¶§‡¶æ‡¶∞ ‡¶™‡¶•‡ßá! üåü ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡ßã ‚Äî ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶¨‡¶æ‡ßú‡¶¨‡ßá‡•§‚Äù</div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-primary touch" onclick="closeWelcome()">‡¶ö‡¶≤ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶ø</button>
      <button class="btn btn-ghost touch" onclick="closeWelcome()">‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶¨</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   CONFIG
   ========================= */
const ADMIN_TG_ID = "6728725622";
const BOT_BASE_LINK = "https://t.me/sweetcashapp_bot";
const CONFIG = {
  adEarning: 2.00,            // reward per ad view
  refBonus: 5.00,            // per refer
  minRefsToWithdraw: 5,
  cooldownMs: 30000,         // ad cooldown between views (30s)
  adHourlyLimit: 20,         // max views per hour
  socialDefaultReward: 5.00, // default task reward
  withdrawMethods: [
    {key:'bkash', label:'‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂', min:250, charge:15},
    {key:'nagad', label:'‡¶®‡¶ó‡¶¶', min:400, charge:20},
    {key:'bank', label:'‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï', min:850, charge:30}
  ],
  adRotationInterval: 15000 // demo rotation
};

/* =========================
   STORAGE KEYS
   ========================= */
const KEY_USERS_INDEX = 'ti_users_idx_v3';
const KEY_WITHDRAWS = 'ti_withdraws_v3';
const KEY_TASKS = 'ti_tasks_v3';
const KEY_GUEST = 'ti_guest_v3';
const KEY_REF_FLAG = 'ti_ref_flag_';
const KEY_AD_VIEWS = 'ti_ad_views_v3'; // stores per-user timestamps (object keyed by userId)

/* =========================
   TELEGRAM WEBAPP INIT
   ========================= */
let tg=null, tgUser=null;
try {
  tg = window.Telegram.WebApp;
  tg.ready(); tg.expand();
  if(tg.initDataUnsafe) tgUser = tg.initDataUnsafe.user;
  if(tgUser){
    document.getElementById('tgUserInfo').innerText = `Telegram: ${tgUser.first_name || ''} ${tgUser.username ? '('+tgUser.username+')' : ''} ‚Äî id: ${tgUser.id}`;
  }
} catch(e){ console.warn('Telegram not available'); }

/* =========================
   HELPERS
   ========================= */
function nowStr(){ return new Date().toLocaleString('bn-BD'); }
function uid(){ return 'u_'+Date.now()+'_'+Math.random().toString(36).slice(2,6); }
function toast(msg){ const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); }
function vibrate(ms=12){ if(navigator.vibrate) navigator.vibrate(ms); }

/* =========================
   LocalStorage helpers
   ========================= */
function getIndex(){ try{ const s=localStorage.getItem(KEY_USERS_INDEX); return s?JSON.parse(s):[]; }catch(e){return []} }
function saveIndex(arr){ localStorage.setItem(KEY_USERS_INDEX, JSON.stringify(arr)); }
function saveUser(id, data){ localStorage.setItem(id, JSON.stringify(data)); let idx=getIndex(); if(!idx.includes(id)){ idx.push(id); saveIndex(idx); } }
function getUser(id){ const s=localStorage.getItem(id); return s?JSON.parse(s):null; }
function deleteUser(id){ localStorage.removeItem(id); let idx=getIndex().filter(x=>x!==id); saveIndex(idx); }
function getWithdraws(){ const s=localStorage.getItem(KEY_WITHDRAWS); return s?JSON.parse(s):[]; }
function saveWithdraws(arr){ localStorage.setItem(KEY_WITHDRAWS, JSON.stringify(arr)); }
function addWithdraw(entry){ const a=getWithdraws(); a.unshift(entry); saveWithdraws(a); }
function getTasks(){ const s=localStorage.getItem(KEY_TASKS); return s?JSON.parse(s):[]; }
function saveTasks(arr){ localStorage.setItem(KEY_TASKS, JSON.stringify(arr)); }

/* =========================
   CURRENT USER SETUP
   ========================= */
let CURRENT_USER_ID = (tgUser && tgUser.id) ? `tg_${tgUser.id}` : null;
function ensureCurrentUser(){
  if(!CURRENT_USER_ID){
    let guest = localStorage.getItem(KEY_GUEST);
    if(!guest){ guest = uid(); localStorage.setItem(KEY_GUEST, guest); }
    CURRENT_USER_ID = guest;
  }
  let u = getUser(CURRENT_USER_ID);
  if(!u){ u = { id:CURRENT_USER_ID, balance:0, adsWatched:0, refs:0, totalEarned:0, createdAt: nowStr(), lastAd:0 }; saveUser(CURRENT_USER_ID, u); }
  // referral param handling
  try {
    const params = new URLSearchParams(window.location.search);
    const start = params.get('start');
    if(start && start.startsWith('ref_')){
      const refId = start.replace('ref_','');
      if(refId && refId !== CURRENT_USER_ID){
        const flagKey = KEY_REF_FLAG + refId + '_' + CURRENT_USER_ID;
        if(!localStorage.getItem(flagKey)){
          let refUser = getUser(refId) || { id:refId, balance:0, refs:0, totalEarned:0 };
          refUser.refs = (refUser.refs||0) + 1;
          refUser.balance = (refUser.balance||0) + CONFIG.refBonus;
          refUser.totalEarned = (refUser.totalEarned||0) + CONFIG.refBonus;
          saveUser(refId, refUser);
          localStorage.setItem(flagKey, '1');
          toast('Referral registered ‚Äî referrer credited');
        }
      }
    }
  } catch(e){}
}

/* =========================
   Ad views per hour logic
   ========================= */
function _getAdViewsStore(){ try{ const s=localStorage.getItem(KEY_AD_VIEWS); return s?JSON.parse(s):{}; }catch(e){return {}} }
function _saveAdViewsStore(o){ localStorage.setItem(KEY_AD_VIEWS, JSON.stringify(o)); }
function canViewAd(userId){
  const store = _getAdViewsStore();
  const arr = store[userId] || [];
  const oneHourAgo = Date.now() - (60*60*1000);
  const recent = arr.filter(ts => ts > oneHourAgo);
  return recent.length < CONFIG.adHourlyLimit;
}
function recordAdView(userId){
  const store = _getAdViewsStore();
  const arr = store[userId] || [];
  arr.push(Date.now());
  // keep only last 100 entries
  store[userId] = arr.slice(-200);
  _saveAdViewsStore(store);
}
function adViewsLeft(userId){
  const store = _getAdViewsStore();
  const arr = store[userId] || [];
  const oneHourAgo = Date.now() - (60*60*1000);
  const recent = arr.filter(ts => ts > oneHourAgo);
  return Math.max(0, CONFIG.adHourlyLimit - recent.length);
}

/* =========================
   UI Renderers
   ========================= */
function updateUI(){
  const u = getUser(CURRENT_USER_ID);
  document.getElementById('ui_balance').innerText = `‡ß≥ ${parseFloat((u.balance||0)).toFixed(2)}`;
  document.getElementById('ui_ads').innerText = u.adsWatched||0;
  document.getElementById('ui_refs').innerText = u.refs||0;
  document.getElementById('ui_earned').innerText = `‡ß≥ ${parseFloat((u.totalEarned||0)).toFixed(2)}`;
  document.getElementById('refLink').value = generateRefLink(CURRENT_USER_ID);
  renderTasks();
  renderUserHistory();
  renderUsers();
  renderAdminWithdraws();
  document.getElementById('taskCountChip').innerText = getTasks().length + ' tasks';
  document.getElementById('yourReqCount').innerText = getWithdraws().filter(x=>x.userId===CURRENT_USER_ID).length;
}

/* referral link with your bot */
function generateRefLink(id){
  return `${BOT_BASE_LINK}?start=ref_${id}`;
}
function copyRef(){ const el=document.getElementById('refLink'); el.select(); el.setSelectionRange(0,99999); document.execCommand('copy'); toast('Referral copied'); }

/* =========================
   Tasks
   ========================= */
function loadDefaultTasks(){
  const defaults = [
    { id:'t_fb', title:'Follow on Facebook', link:'https://facebook.com', type:'follow', reward:CONFIG.socialDefaultReward, taxPct:10 },
    { id:'t_tw', title:'Follow on Twitter', link:'https://twitter.com', type:'follow', reward:CONFIG.socialDefaultReward, taxPct:8 },
    { id:'t_yt', title:'Subscribe on YouTube', link:'https://youtube.com', type:'subscribe', reward:CONFIG.socialDefaultReward, taxPct:12 },
    { id:'t_tele', title:'Join Telegram Channel', link:'https://t.me', type:'join', reward:CONFIG.socialDefaultReward, taxPct:5 },
    { id:'t_ig', title:'Follow on Instagram', link:'https://instagram.com', type:'follow', reward:CONFIG.socialDefaultReward, taxPct:7 }
  ];
  saveTasks(defaults);
  toast('Default tasks loaded');
  renderTasks();
}

function renderTasks(){
  const container = document.getElementById('tasksList'); container.innerHTML = '';
  const tasks = getTasks();
  tasks.forEach(t=>{
    const div = document.createElement('div'); div.className='task touch';
    const left = document.createElement('div'); left.className='left';
    left.innerHTML = `<h4>${t.title}</h4><p class="mini">${t.type} ‚Ä¢ Reward ‡ß≥${parseFloat(t.reward).toFixed(2)} ‚Ä¢ Tax ${t.taxPct||0}%</p>`;
    const right = document.createElement('div');
    right.innerHTML = `<button class="btn btn-primary touch" onclick="performTask('${t.id}')">Do ‚Ä¢ ‡ß≥${parseFloat(t.reward).toFixed(2)}</button>`;
    div.appendChild(left); div.appendChild(right); container.appendChild(div);
  });
}

/* user performs a task -> open link & create pending item for admin */
function performTask(taskId){
  const t = getTasks().find(x=>x.id===taskId); if(!t) return;
  window.open(t.link, '_blank');
  const pending = { id:'p_'+Date.now()+'_'+Math.random().toString(36).slice(2,6), userId:CURRENT_USER_ID, taskId:t.id, title:t.title, reward:parseFloat(t.reward), taxPct:parseFloat(t.taxPct||0), status:'pending', createdAt: nowStr() };
  const arr = getWithdraws(); arr.unshift(pending); saveWithdraws(arr);
  toast('Task submitted ‚Äî admin will verify');
  updateUI();
}

/* =========================
   Ads: demo player & limits
   ========================= */
function canPlayAd(){
  const u = getUser(CURRENT_USER_ID);
  if(!canViewAd(CURRENT_USER_ID)) return { ok:false, reason:'hourly_limit' };
  if(u.lastAd && (Date.now() - u.lastAd) < CONFIG.cooldownMs) return { ok:false, reason:'cooldown' , wait: Math.ceil((CONFIG.cooldownMs - (Date.now() - u.lastAd))/1000)};
  return { ok:true };
}

function playAd(){
  const check = canPlayAd();
  if(!check.ok){
    if(check.reason==='hourly_limit') { toast('‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡ßü ‡ß®‡ß¶‡¶ü‡¶ø ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßá‡¶õ‡ßá‡¶®'); return; }
    if(check.reason==='cooldown') { toast(`‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ${check.wait} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®`); return; }
  }
  // show mini loader
  toast('Ad playing...');
  setTimeout(()=>{
    const u = getUser(CURRENT_USER_ID);
    u.balance = (u.balance||0) + CONFIG.adEarning;
    u.adsWatched = (u.adsWatched||0) + 1;
    u.totalEarned = (u.totalEarned||0) + CONFIG.adEarning;
    u.lastAd = Date.now();
    saveUser(CURRENT_USER_ID, u);
    recordAdView(CURRENT_USER_ID);
    vibrate(12);
    toast(`‚úÖ ‡¶Ü‡¶™‡¶®‡¶ø ‡ß≥${CONFIG.adEarning.toFixed(2)} ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶® ‚Äî ‡¶¨‡¶æ‡¶ï‡¶ø: ${adViewsLeft(CURRENT_USER_ID)} ‡¶è‡¶°/‡¶ò‡¶£‡ßç‡¶ü‡¶æ`);
    updateUI();
  }, 3000);
}

/* simulate ad view button */
function simulateAdView(){ playAd(); }

/* =========================
   Withdraw flow
   ========================= */
function withdrawUI(){
  const u = getUser(CURRENT_USER_ID);
  if((u.refs||0) < CONFIG.minRefsToWithdraw){ toast(`‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ${CONFIG.minRefsToWithdraw} ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞`); return; }
  const list = CONFIG.withdrawMethods.map((m,i)=> `${i+1}. ${m.label} (min ‡ß≥${m.min} ‚Ä¢ charge ‡ß≥${m.charge})`).join('\n');
  const choice = prompt(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥${(u.balance||0).toFixed(2)}\n\n‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:\n${list}\n\n‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (1-${CONFIG.withdrawMethods.length})`);
  if(!choice) return;
  const idx = parseInt(choice) - 1; if(isNaN(idx) || !CONFIG.withdrawMethods[idx]){ toast('‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®'); return; }
  const method = CONFIG.withdrawMethods[idx];
  if((u.balance||0) < method.min){ toast(`${method.label} ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡ß≥${method.min} ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®`); return; }
  const gross = parseFloat(u.balance||0);
  const net = gross - method.charge;
  const entry = { id:'w_'+Date.now()+'_'+Math.random().toString(36).slice(2,6), userId:CURRENT_USER_ID, type:'withdraw', method:method.key, methodLabel:method.label, gross:gross, charge:method.charge, net:net, status:'requested', createdAt: nowStr() };
  addWithdraw(entry);
  u.balance = 0; saveUser(CURRENT_USER_ID, u);
  toast('‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
  updateUI();
}

/* render user withdraw & task submissions */
function renderUserHistory(){
  const arr = getWithdraws().filter(x=>x.userId === CURRENT_USER_ID);
  const container = document.getElementById('userHistory'); container.innerHTML='';
  if(arr.length===0){ container.innerHTML = '<div class="muted">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</div>'; return; }
  arr.forEach(a=>{
    const d = document.createElement('div'); d.className='task';
    d.innerHTML = `<div class="left"><strong>${a.type==='withdraw' ? a.methodLabel : 'Task: '+a.title}</strong><p class="mini">${a.createdAt} ‚Ä¢ Status: ${a.status}</p></div><div><div class="chip">‡ß≥ ${(a.net||a.reward||0).toFixed(2)}</div></div>`;
    container.appendChild(d);
  });
  document.getElementById('yourReqCount').innerText = arr.length;
}

/* =========================
   ADMIN: visibility & actions
   ========================= */
function isAdmin(){ return tgUser && String(tgUser.id) === ADMIN_TG_ID; }

function initAdminPanel(){
  if(isAdmin()){
    document.querySelectorAll('.admin-only').forEach(e=>e.style.display='block');
    document.getElementById('notAdminMsg').style.display='none';
  } else {
    document.querySelectorAll('.admin-only').forEach(e=>e.style.display='none');
    document.getElementById('notAdminMsg').style.display='block';
  }
}

/* render users */
function renderUsers(){
  const tbody = document.getElementById('usersTbody'); tbody.innerHTML='';
  const q = (document.getElementById('adminSearch')?.value || '').toLowerCase();
  const idx = getIndex();
  const users = idx.map(id=>getUser(id)).filter(Boolean).filter(u=>!q || u.id.toLowerCase().includes(q)).sort((a,b)=> (b.totalEarned||0) - (a.totalEarned||0));
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="font-weight:700">${u.id}</td>
                    <td>‡ß≥ ${(u.balance||0).toFixed(2)}</td>
                    <td>${u.refs||0}</td>
                    <td>${u.adsWatched||0}</td>
                    <td><div style="display:flex;gap:6px"><button class="btn btn-ghost touch" onclick="adminEdit('${u.id}')">Edit</button><button class="btn btn-danger touch" onclick="adminDelete('${u.id}')">Del</button></div></td>`;
    tbody.appendChild(tr);
  });
}

/* admin edit/delete */
function adminEdit(id){
  if(!isAdmin()){ toast('Access denied'); return; }
  const u = getUser(id); if(!u){ toast('User not found'); return; }
  const newBal = prompt('‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ (‡ß≥):', (u.balance||0));
  if(newBal===null) return; const num=parseFloat(newBal); if(isNaN(num)){ toast('Invalid amount'); return; }
  u.balance = num; saveUser(id,u); toast('Balance updated'); renderUsers(); updateUI();
}
function adminDelete(id){
  if(!isAdmin()) return; if(!confirm('Confirm delete?')) return;
  deleteUser(id); toast('User deleted'); renderUsers(); updateUI();
}
function openCreateUser(){
  if(!isAdmin()){ toast('Access denied'); return; }
  const newid = prompt('User ID (e.g. tg_12345) or empty for auto:') || '';
  const id = newid.trim() || uid();
  if(getUser(id)){ toast('User exists'); return; }
  const u = { id:id, balance:0, adsWatched:0, refs:0, totalEarned:0, createdAt: nowStr() }; saveUser(id,u);
  toast('User created'); renderUsers();
}

/* admin withdraws rendering */
function renderAdminWithdraws(){
  const arr = getWithdraws();
  const container = document.getElementById('adminWithdraws'); container.innerHTML='';
  if(arr.length===0){ container.innerHTML = '<div class="muted">No requests</div>'; return; }
  arr.forEach(item=>{
    const div = document.createElement('div'); div.className='task';
    const left = document.createElement('div'); left.className='left';
    left.innerHTML = `<strong>${ item.type === 'withdraw' ? item.methodLabel + ' ‚Ä¢ ‡ß≥' + (item.net||0).toFixed(2) : 'TASK ‚Ä¢ '+(item.title||'') }</strong><p class="mini">${item.createdAt} ‚Ä¢ ${item.userId} ‚Ä¢ Status: ${item.status}</p>`;
    const right = document.createElement('div');
    if(isAdmin() && (item.status === 'pending' || item.status === 'requested')){
      right.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px"><button class="btn btn-success touch" onclick='adminProcess("${item.id}","approve")'>Approve</button><button class="btn btn-danger touch" onclick='adminProcess("${item.id}","reject")'>Reject</button></div>`;
    } else {
      right.innerHTML = `<div class="mini">${item.status}${item.processedAt? ' ‚Ä¢ '+item.processedAt: ''}</div>`;
    }
    div.appendChild(left); div.appendChild(right); container.appendChild(div);
  });
}

/* admin process: approve/reject */
function adminProcess(id, action){
  if(!isAdmin()){ toast('Access denied'); return; }
  const arr = getWithdraws(); const idx = arr.findIndex(x=>x.id===id); if(idx===-1){ toast('Not found'); return; }
  const item = arr[idx];
  if(action==='approve'){
    arr[idx].status = 'completed'; arr[idx].processedAt = nowStr();
    if(item.taskId || item.title){
      const reward = parseFloat(item.reward || item.net || 0);
      const tax = parseFloat(item.taxPct || 0);
      const taxAmount = (tax/100) * reward;
      const netToUser = reward - taxAmount;
      const u = getUser(item.userId) || { id:item.userId, balance:0, totalEarned:0 };
      u.balance = (u.balance||0) + netToUser;
      u.totalEarned = (u.totalEarned||0) + netToUser;
      saveUser(u.id,u);
      // store tax in admin account
      const adminAcc = getAdminAcc(); adminAcc.taxCollected = (adminAcc.taxCollected||0) + taxAmount; saveAdminAcc(adminAcc);
    }
    toast('Approved');
  } else if(action==='reject'){
    arr[idx].status = 'rejected'; arr[idx].processedAt = nowStr();
    if(item.type === 'withdraw'){
      const u = getUser(item.userId) || { id:item.userId, balance:0 };
      u.balance = (u.balance||0) + (item.gross||0);
      saveUser(u.id,u);
      toast('Rejected & refunded');
    } else {
      toast('Rejected');
    }
  }
  saveWithdraws(arr); renderAdminWithdraws(); renderUsers(); updateUI();
}

/* admin account storage */
const KEY_ADMIN_ACC = 'ti_admin_acc_v3';
function getAdminAcc(){ const s=localStorage.getItem(KEY_ADMIN_ACC); return s?JSON.parse(s):{taxCollected:0}; }
function saveAdminAcc(a){ localStorage.setItem(KEY_ADMIN_ACC, JSON.stringify(a)); }

/* admin add task */
function addTask(){
  if(!isAdmin()){ toast('Access denied'); return; }
  const title = document.getElementById('taskTitle').value.trim();
  const reward = parseFloat(document.getElementById('taskReward').value) || CONFIG.socialDefaultReward;
  const link = document.getElementById('taskLink').value.trim() || 'https://';
  const tax = parseFloat(document.getElementById('taskTax').value) || 0;
  const type = document.getElementById('taskType').value || 'visit';
  if(!title){ toast('Title missing'); return; }
  const id = 't_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
  const tasks = getTasks(); tasks.unshift({ id:id, title:title, link:link, reward:reward, taxPct:tax, type:type }); saveTasks(tasks);
  document.getElementById('taskTitle').value=''; document.getElementById('taskReward').value=''; document.getElementById('taskLink').value=''; document.getElementById('taskTax').value='';
  renderTasks(); toast('Task added');
}

/* export & clear */
function exportData(){
  if(!isAdmin()){ toast('Access denied'); return; }
  const data = { users: getIndex().map(id=>getUser(id)), withdraws: getWithdraws(), tasks: getTasks(), admin:getAdminAcc(), adViews: JSON.parse(localStorage.getItem(KEY_AD_VIEWS) || '{}') };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ti_export_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
}
function clearAllConfirm(){
  if(!isAdmin()) return; if(!confirm('Clear ALL data?')) return;
  getIndex().forEach(id=>localStorage.removeItem(id));
  localStorage.removeItem(KEY_USERS_INDEX);
  localStorage.removeItem(KEY_WITHDRAWS);
  localStorage.removeItem(KEY_TASKS);
  localStorage.removeItem(KEY_ADMIN_ACC);
  localStorage.removeItem(KEY_GUEST);
  localStorage.removeItem(KEY_AD_VIEWS);
  toast('All cleared');
  updateUI();
}

/* admin helpers */
function adminLogout(){ toast('Admin logout (UI)'); document.querySelectorAll('.admin-only').forEach(e=>e.style.display='none'); document.getElementById('notAdminMsg').style.display='block'; }

/* create default tasks if none */
(function bootstrap(){
  ensureCurrentUser();
  if(!getTasks() || getTasks().length===0) loadDefaultTasks();
  const idx = getIndex(); if(!idx.includes(CURRENT_USER_ID)){ idx.push(CURRENT_USER_ID); saveIndex(idx); }
  initAdminPanel();
  updateUI();
})();

/* refresh */
function refreshAll(){ updateUI(); renderAdminWithdraws(); renderUsers(); }

/* welcome popup once */
(function showWelcomeOnce(){
  const key = 'ti_welcome_shown_v3_' + CURRENT_USER_ID;
  if(!localStorage.getItem(key)){ setTimeout(()=>{ document.getElementById('welcomePopup').classList.add('show'); }, 700); localStorage.setItem(key,'1'); }
})();
function closeWelcome(){ document.getElementById('welcomePopup').classList.remove('show'); }

/* ad rotation demo (toggle text only) */
let adModeIndex = 0; const adModes = ['Adsterra','Monetag'];
function rotateAdMode(){ adModeIndex = (adModeIndex+1) % adModes.length; document.getElementById('adModeChip').innerText = 'Mode: ' + adModes[adModeIndex]; }
setInterval(rotateAdMode, CONFIG.adRotationInterval);

/* Expose some utils for console debugging */
window._TI = { getIndex, getUser, getWithdraws, getTasks, addWithdraw: addWithdraw, saveUser, loadDefaultTasks, getAdminAcc };

/* make some functions accessible from HTML onclick */
window.playAd = playAd; window.performTask = performTask; window.simulateAdView = simulateAdView; window.addTask = addTask; window.loadDefaultTasks = loadDefaultTasks;
window.exportData = exportData; window.clearAllConfirm = clearAllConfirm; window.openCreateUser = openCreateUser; window.adminEdit = adminEdit; window.adminDelete = adminDelete; window.adminProcess = adminProcess;
</script>
</body>
</html>
